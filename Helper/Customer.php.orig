<?php
/**
 * Helps Integration With Customer
 *
 * @copyright   Bread   copyright   2016
 * @author      Joel    @Mediotype
 */
class Bread_BreadCheckout_Helper_Customer extends Bread_BreadCheckout_Helper_Data{

     /**
     * Pass Back Bread Formatted Default Customer Address If It Exists
     *
     * @return array
     */
    public function getFormattedDefaultShippingAddress()
    {
        $session                    = $this->getCustomerSession();
        $customer                   = $session->getCustomer();

        if( empty($customer) ) {
            return array();
        }

        $defaultShippingAddress     = $customer->getPrimaryShippingAddress();

        if( empty($defaultShippingAddress) ) {
            return array();
        }

        $primaryData        = array(
            'fullName'      => $defaultShippingAddress->getName(),
            'address'       => $defaultShippingAddress->getStreet1() . ($defaultShippingAddress->getStreet2() == '' ? '' : (' ' . $defaultShippingAddress->getStreet2())),
            'address2'      => $defaultShippingAddress->getStreet3() . ($defaultShippingAddress->getStreet4() == '' ? '' : (' ' . $defaultShippingAddress->getStreet4())),
            'city'          => $defaultShippingAddress->getCity(),
            'state'         => $defaultShippingAddress->getRegionCode(),
            'zip'           => $defaultShippingAddress->getPostcode(),
            'email'         => $customer->getEmail(),
            'phone'         => substr(preg_replace('/[^0-9]+/', '', $defaultShippingAddress->getTelephone()), -10)
        );

        return $primaryData;
    }

    /**
     * Pass Back Bread Formatted Default Customer Address If It Exists
     *
     * @return array
     */
    public function getFormattedDefaultBillingAddress()
    {
        $session                    = $this->getCustomerSession();
        $customer                   = $session->getCustomer();

        if( empty($customer) ) {
            return array();
        }

        $defaultBillingAddress     = $customer->getPrimaryBillingAddress();

        if( empty($defaultBillingAddress) ) {
            return array();
        }

        $primaryData        = array(
            'fullName'      => $defaultBillingAddress->getName(),
            'address'       => $defaultBillingAddress->getStreet1() . ($defaultBillingAddress->getStreet2() == '' ? '' : (' ' . $defaultBillingAddress->getStreet2())),
            'address2'      => $defaultBillingAddress->getStreet3() . ($defaultBillingAddress->getStreet4() == '' ? '' : (' ' . $defaultBillingAddress->getStreet4())),
            'city'          => $defaultBillingAddress->getCity(),
            'state'         => $defaultBillingAddress->getRegionCode(),
            'zip'           => $defaultBillingAddress->getPostcode(),
            'email'         => $customer->getEmail(),
            'phone'         => substr(preg_replace('/[^0-9]+/', '', $defaultBillingAddress->getTelephone()), -10)
        );

        return $primaryData;
    }

    /**
     * Create Customer Called From Order Place Process
     *
     * @param $quote
     * @param $billingContact
     * @param $shippingContact
     * @return Mage_Customer_Model_Customer|void
     * @throws Mage_Core_Exception
     */
    public function createCustomer($quote, $billingContact, $shippingContact)
    {
        $session    = Mage::getSingleton('customer/session');
        if ($session->isLoggedIn()) {
            return $session->getCustomer();
        }

        $quote->setCustomerLastname($billingContact['lastname']);
        $quote->setCustomerFirstname($billingContact['firstname']);

        if ($this->isAutoCreateCustomerAccountEnabled() == false) {
            return;
        }

        $customer   = Mage::getModel('customer/customer');

        $email      = $quote->getCustomerEmail();

        $customer->setWebsiteId(Mage::app()->getWebsite()->getId());
        $customer->loadByEmail($email);
        $isNewCustomer      = false;

        $billingAddress     = Mage::getModel('customer/address');
        $billingAddress->setData($billingContact);
        $shippingAddress    = Mage::getModel('customer/address');
        $shippingAddress->setData($shippingContact);

        if( !$customer->getId() ) {
            $isNewCustomer      = true;
            $customer->setEmail($email);
            $customer->setPassword($customer->generatePassword(7));
            $billingAddress->setIsDefaultBilling('1');
            $billingAddress->setSaveInAddressBook('1');
            $shippingAddress->setIsDefaultShipping('1');
            $shippingAddress->setSaveInAddressBook('1');
            $customer->setPrimaryBillingAddress($billingAddress);
            $customer->setPrimaryShippingAddress($shippingAddress);
            $customer->setLastname($quote->getCustomerLastname());
            $customer->setFirstname($quote->getCustomerFirstname());
        }

        try {
            $customer->save();
            $customer->setConfirmation(null);

            Mage::getSingleton('customer/session')->loginById($customer->getId());
            $quote->setCustomerId($customer->getId());
            $quote->setCustomer($customer);

            if($isNewCustomer) {
                $billingAddress->setCustomerId($customer->getId());
                $billingAddress->setCustomer($customer);
                $customer->addAddress($billingAddress);
                $billingAddress->save();
                $shippingAddress->setCustomerId($customer->getId());
                $shippingAddress->setCustomer($customer);
                $customer->addAddress($shippingAddress);
                $shippingAddress->save();
            }

            $customer->save();

            if($isNewCustomer) {
                $customer->sendNewAccountEmail();
            }
        } catch (Exception $ex) {
            Mage::helper('breadcheckout')->log('Exception While Logging In Customer', 'bread-exception.log');
            Mage::logException($ex);
        }

        return $customer;
    }

     /**
     * Get Default Customer Shipping Address If It Exists
     *
     * @return string
     */
    public function getShippingAddressData()
    {
        if( $this->isUserLoggedIn() == false ){
            return 'false';
        }

        if( $this->hasBillingAddress() == false ){
            return 'false';
        }

        $primaryAddressData     = $this->getFormattedDefaultShippingAddress();

        return Mage::helper('core')->jsonEncode($primaryAddressData);
    }

    /**
     * Get Billing Address Default Data
     *
     * @return string
     */
    public function getBillingAddressData()
    {
        if( $this->isUserLoggedIn() == false ){
            return 'false';
        }

        if( $this->hasBillingAddress() == false ){
            return 'false';
        }

        $primaryAddressData     = $this->getFormattedDefaultBillingAddress();

        return Mage::helper('core')->jsonEncode($primaryAddressData);
    }


    /**
     * Check if Customer has associated addresses
     *
     * @return bool
     */
    public function hasBillingAddress()
    {
        if($this->getCustomerSession()->getCustomer()->getPrimaryBillingAddress() == false){
            return false;
        }

        return true;
    }

     /**
     * Check if current visitor is logged in
     *
     * @return bool
     */
     public function isUserLoggedIn()
     {
         return (bool) $this->getCustomerSession()->isLoggedIn();
     }

    /**
     * Get Current Customer Session
     *
     * @return Mage_Customer_Model_Session
     */
    protected function getCustomerSession()
    {
        return Mage::getSingleton('customer/session');
    }

}